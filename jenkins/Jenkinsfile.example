pipeline {
    agent any
    
    environment {
        // Java 17 ì„¤ì •
        JAVA_HOME = '/usr/lib/jvm/java-17-amazon-corretto'
        
        // Docker Hub ì„¤ì • (ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
        DOCKER_REGISTRY = 'your-dockerhub-username'
        IMAGE_NAME = 'your-dockerhub-repository-name'
        
        // ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ ì •ë³´ (terraform outputì—ì„œ í™•ì¸)
        APP_SERVER_NAME = 'app-server'  // Publish over SSHì—ì„œ ì„¤ì •í•œ ì„œë²„ ì´ë¦„
        APP_SERVER_IP = 'your-app-server-ip'  // terraform output app_public_ipì™€ ì¼ì¹˜
        APP_SERVER_USER = 'ec2-user'
        
        // Jenkins Credentials ID (Jenkinsì—ì„œ ì„¤ì •í•œ IDì™€ ì¼ì¹˜í•´ì•¼ í•¨)
        GITHUB_CREDENTIALS_ID = 'github-credentials'        // GitHub Personal Access Token
        DOCKER_CREDENTIALS_ID = 'dockerhub-credentials'  // Docker Hub ìê²©ì¦ëª…
        SSH_CREDENTIALS_ID = 'ec2-ssh-key'              // EC2 SSH í‚¤
    }
    
   
   stages {
        stage('Clone') {
            steps {
                echo 'Cloning source code from GitHub...'
                // âœ… Credentialì„ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •
                git branch: 'main',
                    credentialsId: "${GITHUB_CREDENTIALS_ID}",
                    url: 'https://github.com/strawberry-develop/todo-spring-boot.git'
            }
        }
        
        stage('Test') {
            steps {
                echo 'Running tests...'
                script {
                    // Gradle wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
                    sh 'chmod +x ./gradlew'
                    
                    // í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                    sh './gradlew clean test'
                }
            }
            post {
                always {
                    // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰ (Gradle ê¸°ì¤€)
                    script {
                        if (fileExists('build/test-results/test/*.xml')) {
                            junit 'build/test-results/test/*.xml'
                        } else {
                            echo 'âš ï¸ No test results found in build/test-results/test/'
                        }
                    }
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'Building application...'
                script {
                    // JAR íŒŒì¼ ë¹Œë“œ
                    sh './gradlew clean bootJar'
                    
                    // ë¹Œë“œëœ JAR íŒŒì¼ í™•ì¸
                    sh 'ls -la build/libs/'
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                echo 'Building Docker image...'
                script {
                    def imageTag = "${BUILD_NUMBER}"
                    def imageName = "${DOCKER_REGISTRY}/${IMAGE_NAME}"
                    
                    // JAR íŒŒì¼ í™•ì¸
                    sh 'ls -la build/libs/'
                    
                    // ì •í™•í•œ JAR íŒŒì¼ëª… ì°¾ê¸° (plain JAR ì œì™¸)
                    def jarFile = sh(
                        script: "find build/libs -name '*.jar' -not -name '*-plain.jar' | head -1",
                        returnStdout: true
                    ).trim()
                    
                    echo "Found JAR file: ${jarFile}"
                    
                    if (!jarFile) {
                        error("No executable JAR file found in build/libs/")
                    }
                    
                    // Dockerfile í™•ì¸ ë° ìƒì„±
                    if (fileExists('Dockerfile')) {
                        echo "âœ… Using existing Dockerfile"
                        sh 'cat Dockerfile'
                    } else {
                        echo "ğŸ“ Creating new Dockerfile"
                        sh """
                        cat > Dockerfile << 'EOF'
FROM eclipse-temurin:17-jre-alpine

# í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (curl for health check)
RUN apk add --no-cache curl

WORKDIR /app

# JAR íŒŒì¼ì„ ì»¨í…Œì´ë„ˆë¡œ ë³µì‚¬
COPY ${jarFile} app.jar

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8080

# í—¬ìŠ¤ì²´í¬ ì¶”ê°€
HEALTHCHECK --interval=30s --timeout=3s --start-period=30s --retries=3 \\
    CMD curl -f http://localhost:8080/actuator/health || exit 1

# Java 17ì„ ìœ„í•œ ìµœì í™”ëœ JVM ì˜µì…˜
ENTRYPOINT ["java", \\
    "-Xms512m", \\
    "-Xmx1024m", \\
    "-XX:+UseG1GC", \\
    "-XX:+UseContainerSupport", \\
    "-Djava.security.egd=file:/dev/./urandom", \\
    "-jar", "app.jar"]
EOF
                        """
                    }
                    
                    // Docker ì´ë¯¸ì§€ ë¹Œë“œ (ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”)
                    try {
                        sh "docker build -t ${imageName}:${imageTag} ."
                        sh "docker tag ${imageName}:${imageTag} ${imageName}:latest"
                        
                        // í™˜ê²½ ë³€ìˆ˜ì— ì´ë¯¸ì§€ ì´ë¦„ ì €ì¥
                        env.DOCKER_IMAGE = "${imageName}:${imageTag}"
                        env.DOCKER_IMAGE_LATEST = "${imageName}:latest"
                        
                        echo "âœ… Docker image built successfully: ${env.DOCKER_IMAGE_LATEST}"
                    } catch (Exception e) {
                        echo "âŒ Docker build failed: ${e.getMessage()}"
                        sh 'cat Dockerfile'  // Dockerfile ë‚´ìš© ì¶œë ¥
                        throw e
                    }
                }
            }
        }
        
        stage('Docker Push') {
            steps {
                echo 'Pushing Docker image to Docker Hub...'
                script {
                    // âœ… withCredentialsë¥¼ ì‚¬ìš©í•œ ì•ˆì •ì ì¸ Docker Hub ë¡œê·¸ì¸
                    withCredentials([usernamePassword(
                        credentialsId: "${DOCKER_CREDENTIALS_ID}",
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        // Docker Hub ë¡œê·¸ì¸
                        sh '''
                            echo "ğŸ” Docker Hub ë¡œê·¸ì¸ ì‹œë„..."
                            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                            echo "âœ… Docker Hub ë¡œê·¸ì¸ ì„±ê³µ!"
                        '''
                        
                        // ì´ë¯¸ì§€ ì •ë³´ í™•ì¸
                        sh """
                            echo "ğŸ“‹ í‘¸ì‹œí•  ì´ë¯¸ì§€ ì •ë³´:"
                            echo "  - Tagged: ${env.DOCKER_IMAGE}"
                            echo "  - Latest: ${env.DOCKER_IMAGE_LATEST}"
                            docker images | grep "${DOCKER_REGISTRY}/${IMAGE_NAME}" || echo "ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
                        """
                        
                        // Docker ì´ë¯¸ì§€ í‘¸ì‹œ
                        sh """
                            echo "ğŸ“¤ Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì‹œì‘..."
                            
                            echo "  â¤ íƒœê·¸ëœ ì´ë¯¸ì§€ í‘¸ì‹œ: ${env.DOCKER_IMAGE}"
                            docker push ${env.DOCKER_IMAGE}
                            
                            echo "  â¤ Latest ì´ë¯¸ì§€ í‘¸ì‹œ: ${env.DOCKER_IMAGE_LATEST}"
                            docker push ${env.DOCKER_IMAGE_LATEST}
                            
                            echo "âœ… Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ!"
                        """
                        
                        // Docker Hub ë¡œê·¸ì•„ì›ƒ (ë³´ì•ˆ)
                        sh 'docker logout'
                    }
                }
            }
        }
        
        stage('Deploy with Publish over SSH') {
            steps {
                echo 'Deploying to application server using Publish over SSH...'
                
                script {
                    // Docker Hub ìê²©ì¦ëª…ì„ í¬í•¨í•œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
                    withCredentials([usernamePassword(
                        credentialsId: "${DOCKER_CREDENTIALS_ID}",
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        
                        writeFile file: 'deploy.sh', text: """#!/bin/bash
set -e

echo "ğŸš€ Starting deployment of ${env.DOCKER_IMAGE_LATEST}..."

echo "ğŸ” Docker Hub ë¡œê·¸ì¸..."
echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin
echo "âœ… Docker Hub ë¡œê·¸ì¸ ì„±ê³µ!"

echo "=== Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ pull ==="
docker pull ${env.DOCKER_IMAGE_LATEST}

echo "=== ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±° ==="
docker stop todo-app-container 2>/dev/null || echo "No running container to stop"
docker rm todo-app-container 2>/dev/null || echo "No container to remove"

echo "=== ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ==="
docker run -d \\
    --name todo-app-container \\
    --restart unless-stopped \\
    -p 8080:8080 \\
    -v /var/log/todo-app:/app/logs \\
    ${env.DOCKER_IMAGE_LATEST}

echo "â³ ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° (10ì´ˆ)..."
sleep 10

echo "=== ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ==="
docker ps | grep todo-app-container

echo "=== ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸ (ë§ˆì§€ë§‰ 20ì¤„) ==="
docker logs --tail 20 todo-app-container

echo "=== ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬ ==="
docker image prune -f

echo "ğŸ”’ Docker Hub ë¡œê·¸ì•„ì›ƒ (ë³´ì•ˆ)"
docker logout

echo "âœ… ë°°í¬ ì™„ë£Œ!"
"""
                        
                        // Publish over SSHë¡œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡ ë° ì‹¤í–‰
                        sshPublisher(
                            publishers: [
                                sshPublisherDesc(
                                    configName: env.APP_SERVER_NAME,
                                    verbose: true,
                                    transfers: [
                                        sshTransfer(
                                            sourceFiles: 'deploy.sh',
                                            removePrefix: '',
                                            remoteDirectory: '',
                                            execCommand: 'chmod +x deploy.sh && ./deploy.sh'
                                        )
                                    ]
                                )
                            ]
                        )
                    }
                }
            }
        }
        
        stage('Health Check with Publish over SSH') {
            steps {
                echo 'Checking application health using Publish over SSH...'
                
                // í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
                writeFile file: 'health-check.sh', text: """#!/bin/bash
set -e

echo "ğŸ¥ Starting health check..."

MAX_RETRIES=30
RETRY_COUNT=0
HEALTH_URL="http://localhost:8080/actuator/health"
FALLBACK_URL="http://localhost:8080/"

while [ \$RETRY_COUNT -lt \$MAX_RETRIES ]; do
    echo "â³ Health check attempt \$((\$RETRY_COUNT + 1))/\$MAX_RETRIES..."
    
    # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
    if ! docker ps | grep -q todo-app-container; then
        echo "âŒ Container is not running!"
        docker ps -a | grep todo-app-container || echo "Container not found"
        exit 1
    fi
    
    # Health endpoint í™•ì¸
    if curl -f -s \$HEALTH_URL > /dev/null 2>&1; then
        echo "âœ… Health check passed!"
        echo "ğŸ“Š Health check response:"
        curl -s \$HEALTH_URL | jq . 2>/dev/null || curl -s \$HEALTH_URL
        exit 0
    elif curl -f -s \$FALLBACK_URL > /dev/null 2>&1; then
        echo "âœ… Fallback health check passed!"
        echo "ğŸ“Š Application is responding on root endpoint"
        exit 0
    else
        RETRY_COUNT=\$((\$RETRY_COUNT + 1))
        echo "âš ï¸ Health check failed, retrying in 10 seconds..."
        sleep 10
    fi
done

echo "âŒ Health check failed after \$MAX_RETRIES attempts"
echo "ğŸ“‹ Container logs (last 50 lines):"
docker logs --tail 50 todo-app-container || echo "Failed to get container logs"

echo "ğŸ“‹ Container status:"
docker ps -a | grep todo-app-container || echo "Container not found"

exit 1
"""
                
                // Publish over SSHë¡œ í—¬ìŠ¤ì²´í¬ ì‹¤í–‰
                sshPublisher(
                    publishers: [
                        sshPublisherDesc(
                            configName: env.APP_SERVER_NAME,
                            verbose: true,
                            transfers: [
                                sshTransfer(
                                    sourceFiles: 'health-check.sh',
                                    removePrefix: '',
                                    remoteDirectory: '',
                                    execCommand: 'chmod +x health-check.sh && ./health-check.sh'
                                )
                            ]
                        )
                    ]
                )
            }
        }
        
        stage('Final Status') {
            steps {
                echo 'Getting final deployment status...'
                sshPublisher(
                    publishers: [
                        sshPublisherDesc(
                            configName: env.APP_SERVER_NAME,
                            transfers: [
                                sshTransfer(
                                    execCommand: '''
                                        echo "=== ìµœì¢… ë°°í¬ ìƒíƒœ ==="
                                        echo "ğŸ“‹ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
                                        docker ps | grep todo-app-container
                                        
                                        echo "ğŸ” ì»¨í…Œì´ë„ˆ ì„¸ë¶€ ì •ë³´:"
                                        docker inspect todo-app-container --format='{{.State.Status}} {{.State.Health.Status}} {{.RestartCount}}'
                                        
                                        echo "ğŸ“Š ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰:"
                                        docker stats --no-stream todo-app-container
                                        
                                        echo "ğŸŒ ë„¤íŠ¸ì›Œí¬ í¬íŠ¸ í™•ì¸:"
                                        netstat -tlnp | grep :8080 || echo "Port 8080 not found in netstat"
                                        
                                        echo "âœ… ë°°í¬ ì™„ë£Œ! ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://$(curl -s ifconfig.me):8080"
                                    '''
                                )
                            ]
                        )
                    ]
                )
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline execution completed.'
            
            // ë¡œì»¬ Docker ì´ë¯¸ì§€ ì •ë¦¬ (ì•ˆì „í•œ ì—ëŸ¬ ì²˜ë¦¬)
            script {
                try {
                    sh 'docker system prune -f'
                    echo 'âœ… Docker cleanup completed successfully'
                } catch (Exception e) {
                    echo "âš ï¸ Docker cleanup failed (this is not critical): ${e.getMessage()}"
                }
            }
            
            // ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ì •ë¦¬
            script {
                try {
                    sh 'rm -f deploy.sh health-check.sh'
                    echo 'âœ… Script files cleaned up'
                } catch (Exception e) {
                    echo "âš ï¸ Script cleanup failed: ${e.getMessage()}"
                }
            }
        }
        
        success {
            echo 'ğŸ‰ Deployment successful!'
            echo "âœ… Application URL: http://${APP_SERVER_IP}:8080"
            echo "ğŸ³ Docker Image: ${env.DOCKER_IMAGE_LATEST}"
        }
        
        failure {
            echo 'âŒ Deployment failed!'
            
            // ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ìˆ˜ì§‘ (Publish over SSH ë°©ì‹)
            script {
                try {
                    writeFile file: 'debug.sh', text: '''#!/bin/bash
echo "=== ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘ ==="

echo "ğŸ“‹ ëª¨ë“  Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
docker ps -a

echo "ğŸ“‹ Docker ì´ë¯¸ì§€ ëª©ë¡:"
docker images | head -10

echo "ğŸ“‹ ì‹œìŠ¤í…œ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
df -h

echo "ğŸ“‹ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
free -h

echo "ğŸ“‹ todo-app-container ë¡œê·¸ (ë§ˆì§€ë§‰ 100ì¤„):"
docker logs --tail 100 todo-app-container 2>/dev/null || echo "No container logs available"

echo "ğŸ“‹ ì‹œìŠ¤í…œ ë¡œê·¸ (ë§ˆì§€ë§‰ 20ì¤„):"
sudo journalctl --no-pager -n 20

echo "=== ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘ ì™„ë£Œ ==="
'''
                    
                    sshPublisher(
                        publishers: [
                            sshPublisherDesc(
                                configName: env.APP_SERVER_NAME,
                                transfers: [
                                    sshTransfer(
                                        sourceFiles: 'debug.sh',
                                        removePrefix: '',
                                        remoteDirectory: '',
                                        execCommand: 'chmod +x debug.sh && ./debug.sh'
                                    )
                                ]
                            )
                        ]
                    )
                } catch (Exception e) {
                    echo "ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘ ì‹¤íŒ¨: ${e.getMessage()}"
                }
            }
        }
        
        cleanup {
            // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë¦¬
            cleanWs()
        }
    }
} 