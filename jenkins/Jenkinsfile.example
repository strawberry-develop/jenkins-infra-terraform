pipeline {
    agent any
    
    environment {
        // Java 17 ì„¤ì •
        JAVA_HOME = '/usr/lib/jvm/java-17-amazon-corretto'
        
        // Docker Hub ë˜ëŠ” ECR ì„¤ì •
        DOCKER_REGISTRY = 'your-dockerhub-username'
        IMAGE_NAME = 'springboot-cicd-app'
        
        // ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ ì •ë³´ (Terraform outputì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        APP_SERVER_IP = 'your-app-server-ip'
        APP_SERVER_USER = 'ec2-user'
        
        // Docker Hub ìê²© ì¦ëª… ID (Jenkins Credentialsì—ì„œ ì„¤ì •)
        DOCKER_CREDENTIALS_ID = 'dockerhub-credentials'
        
        // SSH í‚¤ ìê²© ì¦ëª… ID (Jenkins Credentialsì—ì„œ ì„¤ì •)
        SSH_CREDENTIALS_ID = 'ec2-ssh-key'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
            }
        }
        
        stage('Test') {
            steps {
                echo 'Running tests...'
                script {
                    if (fileExists('mvnw')) {
                        sh './mvnw clean test'
                    } else {
                        sh 'mvn clean test'
                    }
                }
            }
            post {
                always {
                    // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰
                    publishTestResults testResultsPattern: 'target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'Building application...'
                script {
                    if (fileExists('mvnw')) {
                        sh './mvnw clean package -DskipTests'
                    } else {
                        sh 'mvn clean package -DskipTests'
                    }
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                echo 'Building Docker image...'
                script {
                    def imageTag = "${BUILD_NUMBER}"
                    def imageName = "${DOCKER_REGISTRY}/${IMAGE_NAME}"
                    
                    // Docker ì´ë¯¸ì§€ ë¹Œë“œ
                    def dockerImage = docker.build("${imageName}:${imageTag}")
                    
                    // latest íƒœê·¸ë„ ìƒì„±
                    sh "docker tag ${imageName}:${imageTag} ${imageName}:latest"
                    
                    // í™˜ê²½ ë³€ìˆ˜ì— ì´ë¯¸ì§€ ì´ë¦„ ì €ì¥
                    env.DOCKER_IMAGE = "${imageName}:${imageTag}"
                    env.DOCKER_IMAGE_LATEST = "${imageName}:latest"
                }
            }
        }
        
        stage('Docker Push') {
            steps {
                echo 'Pushing Docker image to registry...'
                script {
                    docker.withRegistry('https://index.docker.io/v1/', DOCKER_CREDENTIALS_ID) {
                        // ë¹Œë“œ ë²ˆí˜¸ íƒœê·¸ í‘¸ì‹œ
                        sh "docker push ${env.DOCKER_IMAGE}"
                        // latest íƒœê·¸ í‘¸ì‹œ
                        sh "docker push ${env.DOCKER_IMAGE_LATEST}"
                    }
                }
            }
        }
        
        stage('Deploy to App Server') {
            steps {
                echo 'Deploying to application server...'
                script {
                    sshagent(credentials: [SSH_CREDENTIALS_ID]) {
                        // ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ì— ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
                        sh """
                            ssh -o StrictHostKeyChecking=no ${APP_SERVER_USER}@${APP_SERVER_IP} '
                                # Docker ì´ë¯¸ì§€ pull
                                docker pull ${env.DOCKER_IMAGE_LATEST}
                                
                                # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
                                docker stop springboot-app-container || true
                                docker rm springboot-app-container || true
                                
                                # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                                docker run -d \\
                                    --name springboot-app-container \\
                                    --restart unless-stopped \\
                                    -p 8080:8080 \\
                                    -v /var/log/springboot:/app/logs \\
                                    ${env.DOCKER_IMAGE_LATEST}
                                
                                # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
                                sleep 10
                                docker ps | grep springboot-app-container
                            '
                        """
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'Performing health check...'
                script {
                    def maxRetries = 30
                    def retryCount = 0
                    def healthCheckUrl = "http://${APP_SERVER_IP}:8080/actuator/health"
                    
                    while (retryCount < maxRetries) {
                        try {
                            def response = sh(
                                script: "curl -f -s ${healthCheckUrl}",
                                returnStatus: true
                            )
                            
                            if (response == 0) {
                                echo "âœ… Application is healthy!"
                                break
                            } else {
                                retryCount++
                                echo "â³ Waiting for application to start... (${retryCount}/${maxRetries})"
                                sleep(10)
                            }
                        } catch (Exception e) {
                            retryCount++
                            echo "â³ Health check failed, retrying... (${retryCount}/${maxRetries})"
                            sleep(10)
                        }
                    }
                    
                    if (retryCount >= maxRetries) {
                        error("âŒ Health check failed after ${maxRetries} attempts")
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline execution completed.'
            
            // ë¡œì»¬ Docker ì´ë¯¸ì§€ ì •ë¦¬ (ì˜µì…˜)
            sh 'docker system prune -f'
        }
        
        success {
            echo 'ğŸ‰ Deployment successful!'
            
            // ì„±ê³µ ì•Œë¦¼ (Slack, ì´ë©”ì¼ ë“±)
            // slackSend(
            //     channel: '#deployments',
            //     color: 'good',
            //     message: "âœ… Deployment successful: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            // )
        }
        
        failure {
            echo 'âŒ Deployment failed!'
            
            // ì‹¤íŒ¨ ì•Œë¦¼
            // slackSend(
            //     channel: '#deployments',
            //     color: 'danger',
            //     message: "âŒ Deployment failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            // )
        }
        
        cleanup {
            // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë¦¬
            cleanWs()
        }
    }
} 